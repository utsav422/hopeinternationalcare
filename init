#!/bin/bash

# Hope International Website - Initialization Script
# This script sets up the development environment for the Hope International website

echo "ğŸš€ Initializing Hope International Website Development Environment"

# Check if we're in the correct directory
if [ ! -f "package.json" ]; then
    echo "âŒ Error: package.json not found. Please run this script from the project root directory."
    exit 1
fi

echo "âœ… Found project root directory"

# Install dependencies
echo "ğŸ“¦ Installing dependencies..."
npm ci
if [ $? -ne 0 ]; then
    echo "âŒ Error: Failed to install dependencies"
    exit 1
fi

echo "âœ… Dependencies installed successfully"

# Check if environment file exists
if [ ! -f ".env.local" ]; then
    echo "âš ï¸  .env.local not found. Copying .env.example to .env.local"
    cp .env.example .env.local
    echo "âœ… .env.local created. Please update the environment variables with your configuration."
else
    echo "âœ… Environment file found"
fi

# Generate Supabase types
echo "ğŸ”„ Generating Supabase types..."
npm run generate-types
if [ $? -ne 0 ]; then
    echo "âŒ Error: Failed to generate Supabase types"
    exit 1
fi

echo "âœ… Supabase types generated successfully"

# Run database migrations
echo "ğŸ”„ Running database migrations..."
npx drizzle-kit push
if [ $? -ne 0 ]; then
    echo "âŒ Error: Failed to run database migrations"
    exit 1
fi

echo "âœ… Database migrations completed successfully"

# Seed database
# echo "ğŸŒ± Seeding database..."
# npm run db:seed
# if [ $? -ne 0 ]; then
#     echo "âŒ Error: Failed to seed database"
#     exit 1
# fi

# echo "âœ… Database seeded successfully"

# Run type checking
echo "ğŸ” Running type checking..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
    echo "âŒ Error: Type checking failed"
    exit 1
fi

echo "âœ… Type checking passed"

# Run linting
echo "ğŸ” Running linting..."
npm run lint
if [ $? -ne 0 ]; then
    echo "âŒ Error: Linting failed"
    exit 1
fi

echo "âœ… Linting passed"

echo ""
echo "ğŸ‰ Initialization complete!"
echo ""
echo "Next steps:"
echo "1. Update .env.local with your configuration values"
echo "2. Run 'npm run dev' to start the development server"
echo "3. Visit http://localhost:3000 to view the application"
echo ""
echo "ğŸ“š Admin Panel Access:"
echo "   - Visit http://localhost:3000/admin to access the admin panel"
echo "   - You'll need to sign in with an admin account"
echo ""
echo "âœ¨ New Features Included:"
echo "   - Affiliation Management System for admin users"
echo "   - Enhanced Course Management System with improved type safety"
echo "   - Better error handling and constraint checking"
echo "   - Optimized image handling for course uploads"
echo ""